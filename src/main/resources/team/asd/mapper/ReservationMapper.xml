<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="team.asd.mapper.ReservationMapper">
    <resultMap id="ResultMap" type="team.asd.entity.Reservation">
        <id column="id" property="id"/>
        <result column="organization_id" property="organizationId"/>
        <result column="agent_id" property="agentId"/>
        <result column="customer_id" property="customerId"/>
        <result column="product_id" property="productId"/>
        <result column="from_date" property="fromDate"/>
        <result column="to_date" property="toDate"/>
        <result column="state" property="state"/>
        <result column="price" property="price"/>
        <result column="quote" property="quote"/>
        <result column="currency" property="currency"/>
        <result column="guests" property="guests"/>
        <result column="notes" property="notes"/>
        <result column="version" property="version"/>
    </resultMap>
    <resultMap id="ResultMapArchivePrice" type="team.asd.entity.ArchivePrice">
        <id column="id" property="id"/>
        <result column="entity_type" property="entityType"/>
        <result column="entity_id" property="entityId"/>
        <result column="name" property="name"/>
        <result column="state" property="state"/>
        <result column="value" property="value"/>
        <result column="version" property="version"/>
        <result column="type" property="type" typeHandler="team.asd.handler.ArchivePriceTypeHandler"/>
    </resultMap>
    <resultMap id="ResultMapReservationConfirmation" type="team.asd.entity.ReservationConfirmation">
        <id column="id" property="id"/>
        <result column="reservation_id" property="reservationId"/>
        <result column="channel_partner_id" property="channelPartnerId"/>
        <result column="confirmation_id" property="confirmationId"/>
        <result column="created_date" property="createdDate"/>
        <result column="version" property="version"/>
    </resultMap>
    <select id="readById" parameterType="int" resultMap="ResultMap" resultType="team.asd.entity.Reservation">
        SELECT id, organization_id, agent_id, customer_id, product_id, state, from_date, to_date, price, quote,
        currency, guests, notes, version
        FROM reservation
        WHERE id =#{id}
    </select>
    <insert id="create" parameterType="team.asd.entity.Reservation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reservation (organization_id, agent_id, customer_id, product_id <if test="state != null">,
        state</if>, from_date, to_date, price, quote,
        currency <if test="guests != null">, guests</if>, notes)
        VALUES (#{organizationId},#{agentId},#{customerId},#{productId},<if test="state != null">#{state},</if>#{fromDate},#{toDate},#{price},#{quote},#{currency},<if
            test="guests != null">#{guests},</if>#{notes})
    </insert>
    <update id="update" parameterType="team.asd.entity.Reservation">
        UPDATE
        reservation
        <set>
            <if test="organizationId!=null">organization_id=#{organizationId},</if>
            <if test="agentId!=null">agent_id=#{agentId},</if>
            <if test="customerId!=null">customer_id=#{customerId},</if>
            <if test="productId!=null">product_id=#{productId},</if>
            <if test="state!=null">state=#{state},</if>
            <if test="fromDate!=null">from_date=#{fromDate},</if>
            <if test="toDate!=null">to_date=#{toDate},</if>
            <if test="price!=null">price=#{price},</if>
            <if test="quote!=null">quote=#{quote},</if>
            <if test="guests!=null">guests=#{guests},</if>
            <if test="currency!=null">currency=#{currency},</if>
            <if test="notes!=null">notes=#{notes}</if>
        </set>
        WHERE id=#{id}
    </update>
    <delete id="delete" parameterType="int">
        UPDATE
        reservation
        SET state='Cancelled'
        WHERE id =#{id}
    </delete>
    <select id="getListByParameters" parameterType="int" resultMap="ResultMap" resultType="team.asd.entity.Reservation">
        SELECT id, organization_id, agent_id, customer_id, product_id, state, from_date, to_date, price, quote,
        currency, guests, notes, version
        FROM reservation
        WHERE product_id = #{productId}
        <if test="organizationId != null">
            and organization_id = #{organizationId}
        </if>
        <if test="agentId != null">
            and agent_id = #{agentId}
        </if>
    </select>
    <select id="getListByDates" parameterType="int" resultMap="ResultMap" resultType="team.asd.entity.Reservation">
        SELECT id, organization_id, agent_id, customer_id, product_id, state, from_date, to_date, price, quote,
        currency, guests, notes, version
        FROM reservation
        WHERE from_date <![CDATA[ >= ]]> #{fromDate}
        and to_date <![CDATA[ < ]]> #{toDate}
        <if test="state != null">
            and state = #{state}
        </if>
    </select>
    <select id="getArchivePrice" parameterType="int" resultMap="ResultMapArchivePrice"
            resultType="team.asd.entity.ArchivePrice">
        SELECT ap.entity_type, ap.name, ap.type, ap.value
        FROM archive_price AS ap
        INNER JOIN reservation AS r ON ap.entity_id = r.id
        WHERE r.id = #{id}
        AND ap.entity_type = 'Reservation'
        AND ap.state = 'Created'
    </select>
    <select id="getReservationConfirmation" parameterType="int" resultMap="ResultMapReservationConfirmation"
            resultType="team.asd.entity.ReservationConfirmation">
        SELECT rc.confirmation_id, rc.created_date
        FROM reservation_confirmation AS rc
        INNER JOIN reservation AS r ON rc.reservation_id = r.id
        WHERE r.id = #{id}
    </select>
</mapper>
